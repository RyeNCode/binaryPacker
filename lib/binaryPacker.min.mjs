class a{#buffer=null;#position=0;#schema={};static#builtInDefs=["string","array","int8","uint8","uint8clamped","int16","uint16","int32","uint32","int64","uint64","float32","float64","datetime"];static#numberMap={int8:Int8Array,uint8:Uint8Array,uint8clamped:Uint8ClampedArray,int16:Int16Array,uint16:Uint16Array,int32:Int32Array,uint32:Uint32Array,int64:BigInt64Array,uint64:BigUint64Array,float32:Float32Array,float64:Float64Array};#pendingDefinitions=[];#definitions={};#validateSchema(e){if(0<this.#pendingDefinitions.length)throw console.error(`undefined types: [${this.#pendingDefinitions.join(",")}]`),new Error("undefined types referenced");if(null==e)return!1;for(var t in e){t=e[t],t=("array"===t.type?t.options:t).type;if(!a.#builtInDefs.includes(t)&&!this.#definitions.hasOwnProperty(t))return console.error(t+" is not defined"),!1}return!0}#readDefintions(e){if(null!=e)for(var t in e){if(a.#builtInDefs.includes(t))throw new Error("duplicate definition: "+t);if(this.#definitions.hasOwnProperty(t))throw new Error("duplicate definition: "+t);this.#pendingDefinitions.includes(t)&&-1<(i=this.#pendingDefinitions.indexOf(t))&&this.#pendingDefinitions.splice(i,1);var i=e[t];"complex"===i.type?(this.#definitions[t]=i,this.#readDefintions(i.schema)):"array"===i.type||a.#builtInDefs.includes(i.type)?this.#definitions[t]=i:this.#pendingDefinitions.includes(i.type)||this.#definitions.hasOwnProperty(i.type)||this.#pendingDefinitions.push(i.type)}}#byteAlignAdj(e){this.#position+=e-this.#position%e&~e}#checkBufferLength(e){e=this.#position+(e*=2);e>this.#buffer.byteLength&&this.#expandBuffer(e)}#expandBuffer(e){this.#buffer.resizeable?this.#buffer.resize(e):(e=new ArrayBuffer(e),new Uint8Array(e).set(new Uint8Array(this.#buffer)),this.#buffer=e)}#shrinkBuffer(e){this.#buffer=this.#buffer.slice(0,e)}#encodeDate(e,t){if(t instanceof Date==!1)throw new Error("not a Date");t=BigInt(t.getTime());this.#encodeNumber(BigUint64Array,null,t)}#decodeDate(e){var t=Number(this.#decodeNumber(BigUint64Array,null));return console.log("Decoded Date: "+t),new Date(t)}#encodeArray(t,i){if(null==i&&(i=[]),!1===Array.isArray(i))throw new Error("element is not an array");this.#encodeNumber(Uint32Array,{},i.length);for(let e=0;e<i.length;e++)this.#encodeComponent(t.type,t.typeOptions,i[e])}#decodeArray(t){this.#byteAlignAdj(Uint32Array.BYTES_PER_ELEMENT);var i=this.#decodeNumber(Uint32Array,{}),n=new Array(i);for(let e=0;e<i;e++){var r=this.#decodeComponent(t.type,t.typeOptions);n[e]=r}return n}#encodeString(e,t){e&&void 0!==e.content&&null!==e.content&&(t=e.content);e=(new TextEncoder).encode(t);this.#encodeNumber(Uint32Array,null,e.length),this.#checkBufferLength(e.length),new Uint8Array(this.#buffer,this.#position,e.length).set(e),this.#position+=e.length}#decodeString(e){var t=this.#decodeNumber(Uint32Array,null),i=new Uint8Array(this.#buffer,this.#position,t),t=(this.#position+=t,(new TextDecoder).decode(i));if(e&&void 0!==e.content&&null!==e.content&&t!==e.content)throw new Error("string content doesn't match schema definition");return t}#encodeNumber(e,t,i){this.#byteAlignAdj(e.BYTES_PER_ELEMENT),this.#checkBufferLength(e.BYTES_PER_ELEMENT),new e(this.#buffer,this.#position,1).set([i]),this.#position+=e.BYTES_PER_ELEMENT}#decodeNumber(e,t){this.#byteAlignAdj(e.BYTES_PER_ELEMENT);var i=new e(this.#buffer,this.#position,1)[0];return this.#position+=e.BYTES_PER_ELEMENT,i}#encodeComponent(e,t,i){if(a.#builtInDefs.includes(e))switch(e){case"array":this.#encodeArray(t,i);break;case"string":this.#encodeString(t,i);break;case"int8":case"uint8":case"uint8clamped":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":this.#encodeNumber(a.#numberMap[e],t,i);break;case"datetime":this.#encodeDate(t,i);break;default:throw new Error(`Built-In type ${e} not handled`)}else{var n=this.#definitions[e];if(void 0===n)throw new Error(e+" is not defined");if("complex"!==n.type){if(a.#builtInDefs.includes(n.type))return this.#encodeComponent(n.type,n.options,i);throw new Error(n.type+" type not yet defined")}var r,s=n.schema;for(r in s){var o=s[r];null==i&&(i={}),this.#encodeComponent(o.type,o.options,i[r])}}}#decodeComponent(e,t){if(!a.#builtInDefs.includes(e)){var i=this.#definitions[e];if("complex"===i.type){var n,r={},s=i.schema;for(n in s){var o=s[n];r[n]=this.#decodeComponent(o.type,o.options)}return r}if(a.#builtInDefs.includes(i.type))return this.#decodeComponent(i.type,i.options);throw new Error(i.type+" type not yet defined")}switch(e){case"array":return this.#decodeArray(t);case"string":return this.#decodeString(t);case"int8":case"uint8":case"uint8clamped":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":return this.#decodeNumber(a.#numberMap[e],t);case"datetime":return this.#decodeDate(t);default:throw new Error(`Built-In type ${e} not handled`)}}constructor(e){if(this.#readDefintions(e.definitions),!1===this.#validateSchema(e.schema))throw new Error("Validation failed");this.#schema=e.schema}encode(e){this.#buffer=new ArrayBuffer(1);var t,i=this.#schema;for(t in this.#position=0,i){var n=this.#schema[t];this.#encodeComponent(n.type,n.options,e[t])}return this.#shrinkBuffer(this.#position),this.#buffer}decode(){var e,t={},i=this.#schema;for(e in this.#position=0,i){var n=this.#schema[e];t[e]=this.#decodeComponent(n.type,n.options)}return t}}Object.freeze(a);export{a as BinaryPacker,a as default};