class h{#buffer=null;#dataView=null;#position=0;#schema={};static#builtInDefs=["string","array","binary","int8","uint8","int16","uint16","int32","uint32","int64","uint64","float32","float64","datetime"];#pendingDefinitions=[];#definitions={};#validateSchema(t){if(null==t)return!1;for(var i in t){i=t[i],i=("array"===i.type?i.options:i).type;h.#builtInDefs.includes(i)||this.#definitions.hasOwnProperty(i)||this.#pendingDefinitions.push(i)}if(0<this.#pendingDefinitions.length)throw new Error(`undefined types: [${this.#pendingDefinitions.join(",")}]`);return!0}#readDefintions(t){if(null!=t)for(var i in t){if(h.#builtInDefs.includes(i))throw new Error("duplicate definition: "+i);if(this.#definitions.hasOwnProperty(i))throw new Error("duplicate definition: "+i);this.#pendingDefinitions.includes(i)&&-1<(e=this.#pendingDefinitions.indexOf(i))&&this.#pendingDefinitions.splice(e,1);var e=t[i];"complex"===e.type?(this.#definitions[i]=e,this.#readDefintions(e.schema)):"array"===e.type||h.#builtInDefs.includes(e.type)?this.#definitions[i]=e:this.#pendingDefinitions.includes(e.type)||this.#definitions.hasOwnProperty(e.type)||this.#pendingDefinitions.push(e.type)}}#byteAlignAdj(t){this.#position+=t-this.#position%t&~t}#isTypedArray(t){return t instanceof Object.getPrototypeOf(Uint8Array)}#checkBufferLength(t){t=this.#position+(t*=2);t>this.#buffer.byteLength&&this.#expandBuffer(t)}#expandBuffer(t){this.#buffer.resizeable?this.#buffer.resize(t):(t=new ArrayBuffer(t),new Uint8Array(t).set(new Uint8Array(this.#buffer)),this.#buffer=t),this.#dataView=new DataView(this.#buffer)}#shrinkBuffer(t){this.#buffer=this.#buffer.slice(0,t),this.#dataView=new DataView(this.#buffer)}#encodeDate(t,i){if(i instanceof Date==!1)throw new Error("not a Date");i=BigInt(i.getTime());this.#checkBufferLength(BigUint64Array.BYTES_PER_ELEMENT),this.#dataView.setBigUint64(this.#position,i),this.#position+=BigUint64Array.BYTES_PER_ELEMENT}#decodeDate(t){var i=Number(this.#dataView.getBigUint64(this.#position));return this.#position+=BigUint64Array.BYTES_PER_ELEMENT,new Date(i)}#encodeArray(i,e){if(null==e&&(e=[]),!1===Array.isArray(e))throw new Error("element is not an array");this.#checkBufferLength(Uint32Array.BYTES_PER_ELEMENT),this.#dataView.setUint32(this.#position,e.length),this.#position+=Uint32Array.BYTES_PER_ELEMENT;for(let t=0;t<e.length;t++)this.#encodeComponent(i.type,i.typeOptions,e[t])}#decodeArray(i){var e=this.#dataView.getUint32(this.#position),n=(this.#position+=Uint32Array.BYTES_PER_ELEMENT,new Array(e));for(let t=0;t<e;t++){var s=this.#decodeComponent(i.type,i.typeOptions);n[t]=s}return n}#encodeString(t,i){t&&void 0!==t.content&&null!==t.content&&(i=t.content);t=(new TextEncoder).encode(i);this.#checkBufferLength(Uint32Array.BYTES_PER_ELEMENT),this.#dataView.setUint32(this.#position,t.length),this.#position+=Uint32Array.BYTES_PER_ELEMENT,this.#checkBufferLength(t.length),new Uint8Array(this.#buffer,this.#position,t.length).set(t),this.#position+=t.length}#decodeString(t){var i=this.#dataView.getUint32(this.#position),e=(this.#position+=Uint32Array.BYTES_PER_ELEMENT,new Uint8Array(this.#buffer,this.#position,i)),i=(this.#position+=i,(new TextDecoder).decode(e));if(t&&void 0!==t.content&&null!==t.content&&i!==t.content)throw new Error(`string content doesn't match schema definition; expected '${t.content}' but found '${i}'`);return i}#encodeBinary(t,i){if(!(i instanceof ArrayBuffer))throw new Error("Not a value of type ArrayBuffer");this.#checkBufferLength(Uint32Array.BYTES_PER_ELEMENT),this.#dataView.setUint32(this.#position,i.byteLength),this.#position+=Uint32Array.BYTES_PER_ELEMENT,this.#checkBufferLength(i.byteLength),new Uint8Array(this.#buffer,this.#position,i.byteLength).set(new Uint8Array(i)),this.#position+=i.byteLength}#decodeBinary(t){var i=this.#dataView.getUint32(this.#position),e=(this.#position+=Uint32Array.BYTES_PER_ELEMENT,new Uint8Array(this.#buffer,this.#position,i)),i=new ArrayBuffer(i);return new Uint8Array(i).set(e),i}#encodeComponent(t,i,e){if(h.#builtInDefs.includes(t))switch(t){case"array":this.#encodeArray(i,e);break;case"string":this.#encodeString(i,e);break;case"int8":this.#checkBufferLength(Int8Array.BYTES_PER_ELEMENT),this.#dataView.setInt8(this.#position,e),this.#position+=Int8Array.BYTES_PER_ELEMENT;break;case"uint8":this.#checkBufferLength(Uint8Array.BYTES_PER_ELEMENT),this.#dataView.setUint8(this.#position,e),this.#position+=Uint8Array.BYTES_PER_ELEMENT;break;case"int16":this.#checkBufferLength(Int16Array.BYTES_PER_ELEMENT),this.#dataView.setInt16(this.#position,e),this.#position+=Int16Array.BYTES_PER_ELEMENT;break;case"uint16":this.#checkBufferLength(Uint16Array.BYTES_PER_ELEMENT),this.#dataView.setUint16(this.#position,e),this.#position+=Uint16Array.BYTES_PER_ELEMENT;break;case"int32":this.#checkBufferLength(Int32Array.BYTES_PER_ELEMENT),this.#dataView.setInt32(this.#position,e),this.#position+=Int32Array.BYTES_PER_ELEMENT;break;case"uint32":this.#checkBufferLength(Uint32Array.BYTES_PER_ELEMENT),this.#dataView.setUint32(this.#position,e),this.#position+=Uint32Array.BYTES_PER_ELEMENT;break;case"int64":this.#checkBufferLength(BigInt64Array.BYTES_PER_ELEMENT),this.#dataView.setBigInt64(this.#position,e),this.#position+=BigInt64Array.BYTES_PER_ELEMENT;break;case"uint64":this.#checkBufferLength(BigUint64Array.BYTES_PER_ELEMENT),this.#dataView.setBigUint64(this.#position,e),this.#position+=BigUint64Array.BYTES_PER_ELEMENT;break;case"float32":this.#checkBufferLength(Float32Array.BYTES_PER_ELEMENT),this.#dataView.setFloat32(this.#position,e),this.#position+=Float32Array.BYTES_PER_ELEMENT;break;case"float64":this.#checkBufferLength(Float64Array.BYTES_PER_ELEMENT),this.#dataView.setFloat64(this.#position,e),this.#position+=Float64Array.BYTES_PER_ELEMENT;break;case"datetime":this.#encodeDate(i,e);break;case"binary":this.#encodeBinary(i,e);break;default:throw new Error(`Built-In type ${t} not handled`)}else{var n=this.#definitions[t];if(void 0===n)throw new Error(t+" is not defined");if("complex"!==n.type){if(h.#builtInDefs.includes(n.type))return this.#encodeComponent(n.type,n.options,e);throw new Error(n.type+" type not yet defined")}var s,r=n.schema;for(s in r){var o=r[s];null==e&&(e={}),this.#encodeComponent(o.type,o.options,e[s])}}}#decodeComponent(t,i){if(!h.#builtInDefs.includes(t)){var e=this.#definitions[t];if("complex"===e.type){var n,s={},r=e.schema;for(n in r){var o=r[n];s[n]=this.#decodeComponent(o.type,o.options)}return s}if(h.#builtInDefs.includes(e.type))return this.#decodeComponent(e.type,e.options);throw new Error(e.type+" type not yet defined")}switch(t){case"array":return this.#decodeArray(i);case"string":return this.#decodeString(i);case"int8":var a=this.#dataView.getInt8(this.#position);return this.#position+=Int8Array.BYTES_PER_ELEMENT,a;case"uint8":a=this.#dataView.getUint8(this.#position);return this.#position+=Uint8Array.BYTES_PER_ELEMENT,a;case"int16":a=this.#dataView.getInt16(this.#position);return this.#position+=Int16Array.BYTES_PER_ELEMENT,a;case"uint16":a=this.#dataView.getUint16(this.#position);return this.#position+=Uint16Array.BYTES_PER_ELEMENT,a;case"int32":a=this.#dataView.getInt32(this.#position);return this.#position+=Int32Array.BYTES_PER_ELEMENT,a;case"uint32":a=this.#dataView.getUint32(this.#position);return this.#position+=Uint32Array.BYTES_PER_ELEMENT,a;case"int64":a=this.#dataView.getBigInt64(this.#position);return this.#position+=BigInt64Array.BYTES_PER_ELEMENT,a;case"uint64":a=this.#dataView.getBigUint64(this.#position);return this.#position+=BigUint64Array.BYTES_PER_ELEMENT,a;case"float32":a=this.#dataView.getFloat32(this.#position);return this.#position+=Float32Array.BYTES_PER_ELEMENT,a;case"float64":a=this.#dataView.getFloat64(this.#position);return this.#position+=Float64Array.BYTES_PER_ELEMENT,a;case"datetime":return this.#decodeDate(i);case"binary":return this.#decodeBinary(i);default:throw new Error(`Built-In type ${t} not handled`)}}constructor(t){if(this.#readDefintions(t.definitions),!1===this.#validateSchema(t.schema))throw new Error("Validation failed");this.#schema=t.schema}encode(t){this.#buffer=new ArrayBuffer(1),this.#dataView=new DataView(this.#buffer);var i,e=this.#schema;for(i in this.#position=0,e){var n=this.#schema[i];this.#encodeComponent(n.type,n.options,t[i])}return this.#shrinkBuffer(this.#position),this.#buffer}decode(t){if(t instanceof ArrayBuffer!=!0)throw new TypeError("input was not of type ArrayBuffer");this.#buffer=t,this.#dataView=new DataView(this.#buffer);var i,e={},t=this.#schema;for(i in this.#position=0,t){var n=this.#schema[i];e[i]=this.#decodeComponent(n.type,n.options)}return e}}Object.freeze(h);export{h as BinaryPacker,h as default};