class a{#buffer=null;#position=0;#schema={};static#builtInDefs=["string","array","binary","int8","uint8","uint8clamped","int16","uint16","int32","uint32","int64","uint64","float32","float64","datetime"];static#numberMap={int8:Int8Array,uint8:Uint8Array,uint8clamped:Uint8ClampedArray,int16:Int16Array,uint16:Uint16Array,int32:Int32Array,uint32:Uint32Array,int64:BigInt64Array,uint64:BigUint64Array,float32:Float32Array,float64:Float64Array};#pendingDefinitions=[];#definitions={};#validateSchema(e){if(0<this.#pendingDefinitions.length)throw console.error(`undefined types: [${this.#pendingDefinitions.join(",")}]`),new Error("undefined types referenced");if(null==e)return!1;for(var t in e){t=e[t],t=("array"===t.type?t.options:t).type;if(!a.#builtInDefs.includes(t)&&!this.#definitions.hasOwnProperty(t))return console.error(t+" is not defined"),!1}return!0}#readDefintions(e){if(null!=e)for(var t in e){if(a.#builtInDefs.includes(t))throw new Error("duplicate definition: "+t);if(this.#definitions.hasOwnProperty(t))throw new Error("duplicate definition: "+t);this.#pendingDefinitions.includes(t)&&-1<(n=this.#pendingDefinitions.indexOf(t))&&this.#pendingDefinitions.splice(n,1);var n=e[t];"complex"===n.type?(this.#definitions[t]=n,this.#readDefintions(n.schema)):"array"===n.type||a.#builtInDefs.includes(n.type)?this.#definitions[t]=n:this.#pendingDefinitions.includes(n.type)||this.#definitions.hasOwnProperty(n.type)||this.#pendingDefinitions.push(n.type)}}#byteAlignAdj(e){this.#position+=e-this.#position%e&~e}#isTypedArray(e){return e instanceof Object.getPrototypeOf(Uint8Array)}#checkBufferLength(e){e=this.#position+(e*=2);e>this.#buffer.byteLength&&this.#expandBuffer(e)}#expandBuffer(e){this.#buffer.resizeable?this.#buffer.resize(e):(e=new ArrayBuffer(e),new Uint8Array(e).set(new Uint8Array(this.#buffer)),this.#buffer=e)}#shrinkBuffer(e){this.#buffer=this.#buffer.slice(0,e)}#encodeDate(e,t){if(t instanceof Date==!1)throw new Error("not a Date");t=BigInt(t.getTime());this.#encodeNumber(BigUint64Array,null,t)}#decodeDate(e){var t=Number(this.#decodeNumber(BigUint64Array,null));return new Date(t)}#encodeArray(t,n){if(null==n&&(n=[]),!1===Array.isArray(n))throw new Error("element is not an array");this.#encodeNumber(Uint32Array,{},n.length);for(let e=0;e<n.length;e++)this.#encodeComponent(t.type,t.typeOptions,n[e])}#decodeArray(t){this.#byteAlignAdj(Uint32Array.BYTES_PER_ELEMENT);var n=this.#decodeNumber(Uint32Array,{}),i=new Array(n);for(let e=0;e<n;e++){var r=this.#decodeComponent(t.type,t.typeOptions);i[e]=r}return i}#encodeString(e,t){e&&void 0!==e.content&&null!==e.content&&(t=e.content);e=(new TextEncoder).encode(t);this.#encodeNumber(Uint32Array,null,e.length),this.#checkBufferLength(e.length),new Uint8Array(this.#buffer,this.#position,e.length).set(e),this.#position+=e.length}#decodeString(e){var t=this.#decodeNumber(Uint32Array,null),n=new Uint8Array(this.#buffer,this.#position,t),t=(this.#position+=t,(new TextDecoder).decode(n));if(e&&void 0!==e.content&&null!==e.content&&t!==e.content)throw new Error("string content doesn't match schema definition");return t}#encodeNumber(e,t,n){this.#byteAlignAdj(e.BYTES_PER_ELEMENT),this.#checkBufferLength(e.BYTES_PER_ELEMENT),new e(this.#buffer,this.#position,1).set([n]),this.#position+=e.BYTES_PER_ELEMENT}#decodeNumber(e,t){this.#byteAlignAdj(e.BYTES_PER_ELEMENT);var n=new e(this.#buffer,this.#position,1)[0];return this.#position+=e.BYTES_PER_ELEMENT,n}#encodeBinary(e,t){if(!(t instanceof ArrayBuffer))throw new Error("Not a value of type ArrayBuffer");this.#encodeNumber(Uint32Array,null,t.byteLength),this.#checkBufferLength(t.byteLength),new Uint8Array(this.#buffer,this.#position,t.byteLength).set(new Uint8Array(t)),this.#position+=t.byteLength}#decodeBinary(e){var t=this.#decodeNumber(Uint32Array,null),n=new Uint8Array(this.#buffer,this.#position,t),t=new ArrayBuffer(t);return new Uint8Array(t).set(n),t}#encodeComponent(e,t,n){if(a.#builtInDefs.includes(e))switch(e){case"array":this.#encodeArray(t,n);break;case"string":this.#encodeString(t,n);break;case"int8":case"uint8":case"uint8clamped":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":this.#encodeNumber(a.#numberMap[e],t,n);break;case"datetime":this.#encodeDate(t,n);break;case"binary":this.#encodeBinary(t,n);break;default:throw new Error(`Built-In type ${e} not handled`)}else{var i=this.#definitions[e];if(void 0===i)throw new Error(e+" is not defined");if("complex"!==i.type){if(a.#builtInDefs.includes(i.type))return this.#encodeComponent(i.type,i.options,n);throw new Error(i.type+" type not yet defined")}var r,s=i.schema;for(r in s){var o=s[r];null==n&&(n={}),this.#encodeComponent(o.type,o.options,n[r])}}}#decodeComponent(e,t){if(!a.#builtInDefs.includes(e)){var n=this.#definitions[e];if("complex"===n.type){var i,r={},s=n.schema;for(i in s){var o=s[i];r[i]=this.#decodeComponent(o.type,o.options)}return r}if(a.#builtInDefs.includes(n.type))return this.#decodeComponent(n.type,n.options);throw new Error(n.type+" type not yet defined")}switch(e){case"array":return this.#decodeArray(t);case"string":return this.#decodeString(t);case"int8":case"uint8":case"uint8clamped":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":return this.#decodeNumber(a.#numberMap[e],t);case"datetime":return this.#decodeDate(t);case"binary":return this.#decodeBinary(t);default:throw new Error(`Built-In type ${e} not handled`)}}constructor(e){if(this.#readDefintions(e.definitions),!1===this.#validateSchema(e.schema))throw new Error("Validation failed");this.#schema=e.schema}encode(e){this.#buffer=new ArrayBuffer(1);var t,n=this.#schema;for(t in this.#position=0,n){var i=this.#schema[t];this.#encodeComponent(i.type,i.options,e[t])}return this.#shrinkBuffer(this.#position),this.#buffer}decode(){var e,t={},n=this.#schema;for(e in this.#position=0,n){var i=this.#schema[e];t[e]=this.#decodeComponent(i.type,i.options)}return t}}Object.freeze(a);export{a as BinaryPacker,a as default};